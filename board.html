<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tldraw Whiteboard | iSpeak.com.pl</title>
    <link rel="stylesheet" href="https://unpkg.com/@tldraw/tldraw@2.1.4/tldraw.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        #root {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <!-- This is where our React app will be rendered -->
    <div id="root"></div>

    <!-- 1. Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 2. React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- 3. Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. tldraw Libraries -->
    <script src="https://unpkg.com/@tldraw/tldraw@2.1.4/tldraw.js"></script>
    <script src="https://unpkg.com/@tldraw/assets@2.1.0/assets.js"></script>

    <!-- 5. Our Application Logic (written in JSX) -->
    <script type="text/babel">

        // --- SETUP ---
        const { createClient } = supabase;
        const { Tldraw, createTLStore, TldrawUi, defaultShapeUtils, Editor, StoreSnapshot, useEditor } = TldrawJs;
        
        // Your Supabase details
        const SUPABASE_URL = 'https://oysjdtlpmawebbncvnqt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95c2pkdGxwbWF3ZWJibmN2bnF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MzA0NjgsImV4cCI6MjA3MTEwNjQ2OH0.JGJRzRfEJLL0TDhIN9DLnLu0TiuT3YRKU55tRdgtSgE';
        const BOARD_ID = 'default';
        const CLIENT_ID = 'client_' + Math.random().toString(36).substring(2, 9);

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // This is our main React Component
        function App() {
            // A simple state to hold the tldraw store
            const [store, setStore] = React.useState(null);

            // This effect runs once on mount
            React.useEffect(() => {
                // 1. Create a new tldraw store
                const newStore = createTLStore({
                    shapeUtils: defaultShapeUtils,
                });

                // 2. Load the initial data from Supabase
                async function loadInitialData() {
                    console.log(`[${CLIENT_ID}] Loading initial board state...`);
                    const { data, error } = await supabaseClient
                        .from('boards')
                        .select('data')
                        .eq('id', BOARD_ID)
                        .single();

                    if (data && data.data) {
                        console.log(`[${CLIENT_ID}] Board found, loading snapshot.`);
                        newStore.loadSnapshot(data.data);
                    } else {
                        console.log(`[${CLIENT_ID}] No board found, starting fresh.`);
                    }
                    // Set the store in state, which will trigger a re-render
                    setStore(newStore);
                }

                loadInitialData();
            }, []); // Empty dependency array means this runs only once

            if (!store) {
                return <div>Loading...</div>;
            }

            return (
                <Tldraw persistenceKey={BOARD_ID} store={store}>
                    <SupabaseSync />
                </Tldraw>
            );
        }

        // This component handles all the real-time logic
        function SupabaseSync() {
            const editor = useEditor();

            // This effect handles SAVING local changes to Supabase
            React.useEffect(() => {
                const handleChange = (change) => {
                    // Only save changes made by the user, not by remote updates
                    if (change.source !== 'user') return;
                    
                    const snapshot = editor.store.getSnapshot();

                    // Debounce the save function
                    const save = async () => {
                        console.log(`%c[${CLIENT_ID}] SAVING to Supabase...`, 'color: blue;');
                        await supabaseClient
                            .from('boards')
                            .upsert({
                                id: BOARD_ID,
                                data: snapshot,
                                last_updated_by: CLIENT_ID,
                            });
                    };

                    // Use a simple timeout as a debounce
                    const timeoutId = setTimeout(save, 500);
                    
                    // Return a cleanup function to cancel the save if a new change comes in
                    return () => clearTimeout(timeoutId);
                };

                const cleanup = editor.store.listen(handleChange, {
                    scope: 'document',
                    source: 'user',
                });

                return () => {
                    cleanup();
                };
            }, [editor]);

            // This effect handles RECEIVING remote changes from Supabase
            React.useEffect(() => {
                const channel = supabaseClient.channel('board-updates');

                const subscription = channel.on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'boards', filter: `id=eq.${BOARD_ID}` },
                    (payload) => {
                        const senderId = payload.new.last_updated_by;
                        
                        // Ignore our own updates
                        if (senderId === CLIENT_ID) return;
                        
                        console.log(`%c[${CLIENT_ID}] Received foreign update. Loading snapshot.`, 'color: green;');
                        const newSnapshot = payload.new.data;
                        
                        // Load the remote snapshot into our store
                        // tldraw handles the diffing and re-rendering
                        editor.store.loadSnapshot(newSnapshot);
                    }
                ).subscribe();

                return () => {
                    supabaseClient.removeChannel(channel);
                };
            }, [editor]);

            return null; // This component doesn't render anything
        }

        // --- Render the App ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
